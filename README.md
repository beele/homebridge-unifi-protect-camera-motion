#Unifi-Protect-Camera-Motion

This Homebridge plugin extends the standard FFMPEG Homebridge plugin and provides your cameras and motion sensors for use in Homekit.

This plugin will enumerate all the cameras in your protect account and provide both a camera and a motion sensor in Homekit for each camera in protect.
Motion events will be triggered either by the motion events from protect itself (when the score is sufficient) or will be processed with Tensorflow for smarter analysis.
The Tensorflow logic/model runs on your device and no data is ever sent to any online source.

To experiment with this plugin:
- Checkout the git repo
- Install Homebridge (you can use `npm run install-homebridge`)
- Adjust the dummy config under `resources/test-config/config.json`
- use `npm run homebridge` to start a homebridge instance that points to the local config

To install this plugin simple type `sudo npm install TODO -g --unsafe-perm=true`.
Next open the config.json that contains your Homebridge configuration and add a block like the following one to the platforms array:

```javascript
{
    "platform": "Unifi-Protect-Camera-Motion",
    "name": "Unifi protect cameras & motion sensors",
    "unifi": {
        "controller": "https://protect-ip:controller-ui-port",
        "controller_rtsp": "rtsp://protect-ip:controller-rtsp-port",
        "username": "username",
        "password": "password",
        "motion_interval": 5000,
        "motion_score": 50,
        "enhanced_motion": true,
        "enhanced_classes": [
            "Person - or any other COCO classes, look in src/coco/classes.ts"
        ]
    },
    "videoConfig": {
        "vcodec": "h264 - or h264_omx",
        "audio": false,
        "maxStreams": 2,
        "maxWidth": 1024,
        "maxHeight": 576,
        "maxFPS": 15,
        "mapvideo": "0:1",
        "mapaudio": "0:0"
    }
}
```
Config fields:

- `platform`: This field is required and has to be `Unifi-Protect-Camera-Motion`
- `name`: This field is required and can be set freely
- `unifi`: This object is required and contains the configuration for unifi
    - `controller`: This field is required and contains the url to the unifi protect web interface
    - `controller_rtsp`: This field is required and contains the base url to be used for playing back the RTSP streams
    - `username`: This field is required and contains the username that is used to login in the web ui
    - `password`: This field is required and contains the password that is used to login in the web ui
    - `motion_interval`: This field is required and contains the interval used to check for motion, a good default is 5000(ms)
    - `motion_score`: This field is required and contains the minimum score a motion event has to have to be processed, a good default is 50 (%)
    - `enhanced_motion`: This field is required and enables or disables the enhanced motion detection with tensorflow, value should be true or false
    - `enhanced_classes`: this field is required and contains an array of string describing the classes of objects to dispatch motion events for, can be empty when the field above is set to false! 
- `videoConfig`: This object is required and contains the general settings for each camera
    - This is the regular videoConfig you would use for the FFMPEG plugin, however the fields `source` and `stillImageSource` should be omitted as these will be generated by the plugin itself!
    - See the [FFMPEG readme](homebridge-camera-ffmpeg.md) for more information.
    - Make sure that your unifi camera has anonymous snapshots enabled and that at least one RTSP stream is enabled 
        - To enable anonymous snapshots: <br/>
          ![Anonymous snapshot](resources/images/anonymous_snapshot.jpg?raw=true "CloudKey Gen2 Plus")
        - To enable an RTSP stream: <br/> 
          ![Enable RTSP stream](resources/images/enable_rtsp.jpg?raw=true "CloudKey Gen2 Plus")

How to add the cameras to your Homekit setup:

- Click the (+) icon on the top
- Select 'Add Accessory'
- In the next screen select 'I Don't Have a Code or Cannot Scan'
- Your cameras should show up in the next screen, select one
- Enter the code for your Homebridge in the prompt, the camera will be added
- Repeat for all the cameras you want to add

How to enable rich notifications (with image preview):

- Go to the settings of the camera in the Home app
- Each camera has an accompanying motion sensor 
- Enable notifications for the camera
- whenever motion is detected you will get a notification from the home app with a snapshot from the camera

Tested with:

- Ubiquiti UniFi CloudKey Gen2 Plus - Cloud key with unifi protect functionality
  <br/>![CloudKey Gen2 Plus](resources/images/cloudkey-gen2plus.jpg?raw=true "CloudKey Gen2 Plus")
- 2x Ubiquiti UniFi Video UVC-G3-AF - PoE Camera
  <br/>![Camera UVC-G3-AF](resources/images/camera.jpeg?raw=true "Camera UVC-G3-AF")
